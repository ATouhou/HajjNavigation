<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=320, user-scalable=no">
		<meta http-equiv="Content-type" content="text/html; charset=utf-8">
		<title>Map Test App</title>
		<style>
			body{
				margin: 0px;
			}
		</style>
		<link rel="stylesheet" href="plugin/leaflet/leaflet.css" />
		<link rel="stylesheet" href="plugin/toolbar/toolbar.css" />
		<link rel="stylesheet" href="css/dd.css" />
		<!--[if lte IE 8]><link rel="stylesheet" href="plugin/leaflet/leaflet.ie.css" /><![endif]-->
		<script src="js/jq.js"></script>
        <script type="text/javascript" src="js/jquery.dd.js"></script>
        <script type="text/javascript" src="js/Astar.js"></script>
        <script type="text/javascript" src="js/init_db.js"></script>
        <script type="text/javascript" src="phonegap.js"></script>
	</head>
	<body>
		<div id="screen">
			<div id="map" style="width: 600px; height: 400px"></div>
		
			<script src="plugin/leaflet/leaflet-src.js"></script>
			<script src="plugin/leaflet/bouncemarker.js"></script>
			<script type="text/javascript" src="js/markers.js"></script>
		
			<script src="plugin/routing/L.Routing.js"></script>
			<script src="plugin/routing/L.Routing.Draw.js"></script>
			<script src="plugin/routing/L.Routing.Edit.js"></script>
			<script src="plugin/routing/L.Routing.Storage.js"></script>
		
			<script src="plugin/routing/utils/LineUtil.Snapping.js"></script>
			<script src="plugin/routing/utils/Marker.Snapping.js"></script>
			<script src="plugin/routing/utils/Polyline.Snapping.js"></script>
		
			<script src="plugin/toolbar/toolbar.js"></script>
			<script>
			$(window).resize(function(){
				$("#map").width("100%");		
				$("#map").height($(window).height());
			});
			
			var info;
			var db = window.openDatabase("Database", "1.0", "HajjNavigation", 2000000);
			
			var my_location = null;
			var state = "NONE";
			lst_poi = {};
	
			function change_state(i_state, i_desc){
				i_desc = typeof i_desc !== 'undefined' ? i_desc : "Arsheet Company";
				state = i_state;
				$(".leaflet-control-attribution").html(i_desc);
			}

			function get_my_location(){
				navigator.geolocation.getCurrentPosition(function(position){
					if(my_location == null){
						L.marker([position.latitude, position.longitude]).addTo(map)
							.bindPopup("You are Here").openPopup();
					}
					my_location.setLatLng([position.latitude, position.longitude]).update();
				}, function(error){
					alert("Error retriving location");
				},
				{
					enableHighAccuracy : true,
					maximumAge: 4000,
					timeout: 5000
				});
			}
			
			function save_title(id, elem){
				db.transaction(function(tx){
					tx.executeSql("UPDATE POI SET [title]=? WHERE [id]=?", [$(elem).val(), id]);
				});
				lst_poi[id].options.icon.options.title = $(elem).val();
			}

			function save_text(id, elem){
				db.transaction(function(tx){
					tx.executeSql("UPDATE POI SET [text]=? WHERE [id]=?", [$(elem).val(), id]);
				});
				lst_poi[id].options.icon.options.text = $(elem).val();
			}

			function delete_poi(id){
				if(confirm("Are you sure you want to remove this POI?")){
					db.transaction(function(tx){
						tx.executeSql("DELETE FROM POI WHERE [id]=?", [id]);
					});
					map.removeLayer(lst_poi[id]);
					lst_poi[id] = undefined;
				}
			}
			
			function gen_poi_popup(poi_id){
				var elems = ['Accommodation', 'ATM', 'Bank', 'Car Aid', 'Education', 'Emergency', 'Entertainment', 'Exchange', 'Food Shop', 'Fuel', 'Geocache', 'Haram Entrance', 'Health', 'Hospital', 'Money', 'Parking', 'Resturant', 'Sightseeing', 'Transport'];
				var select = "<select style='width: 180px;' onchange=\"change_poi_type(" + poi_id + ", this)\">";
				for (var j = 0; j < elems.length; j++)
					select += "<option value='" + elems[j] + "' data-description='' data-image='images/poi/" + elems[j] + ".png'>" + elems[j] + "</option>";
				select += "</select>";
				return "<table cellspacing=0 cellpadding=0><tr><td>Type:</td><td>" + select + "</td></tr><tr><td>Title:</td><td><input type=text onblur='save_title("+poi_id+", this);' /></td></tr><tr><td>Text:</td><td><textarea onblur='save_text("+poi_id+",this);'></textarea></td></tr><tr><td colspan=2 align=right><input type=button value=\"Delete\" onclick='delete_poi("+poi_id+")' /></td></table>";
			}
			
			function init_pois(){
				db.transaction(function(tx){
					tx.executeSql("SELECT [id], [lat], [lon], [type], [title], [text] FROM POI", [], function(tx, result){
						var len = result.rows.length;
						for(var i = 0; i < len; i++){
							var poi_id = result.rows.item(i).id;
							var popup = gen_poi_popup(poi_id);
							lst_poi[poi_id] = L.marker([result.rows.item(i).lat, result.rows.item(i).lon], create_poi_marker(result.rows.item(i).type, result.rows.item(i).title, result.rows.item(i).text)).addTo(map).bindPopup(popup);
						}
					});
				});
			}
			
			function change_poi_type(id, select){
				var new_value = select.value;
				//lst_poi[id].options.icon.options.iconUrl = "images/poi/" + new_value + ".png";
				lst_poi[id].setIcon(create_poi_marker(new_value).icon);
				db.transaction(function(tx){
					tx.executeSql("UPDATE POI SET type=? WHERE id=?", [new_value, id]);
				});
			}

			function get_nearest_node(lat, lon){
				var min_id = -1;
				var min_dist = 999;
				$.each(json, function(id, nodes){
					var d = (nodes.lat - lat)*(nodes.lat - lat) + (nodes.lon - lon)*(nodes.lon - lon);
					if(min_id == -1 || d < min_dist){
						min_id = id;
						min_dist = d;
					}
				});
				return min_id;
			}

			var routing_points = [];
			var routing_markers = [];
			var map, toolbar;
			var route;
			$(document).ready(function(){
				db.transaction(function(tx){
					//tx.executeSql("DROP TABLE POI");
					tx.executeSql("CREATE TABLE IF NOT EXISTS POI ([id] INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, [lat] REAL, [lon] REAL, [type] NVARCHAR(50), [title] NVARCHAR(50), [text] NVARCHAR(300))");
				});
			
				$("#map").width("100%");		
				$("#map").height($(window).height());
				map = L.map('map').setView([21.4236, 39.8269], 12);
				
				toolbar = new L.Control.Toolbar();
				map.addControl(toolbar);

				//L.tileLayer('http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/997/256/{z}/{x}/{y}.png', {
				info = L.tileLayer('map_data/{z}/{x}/{y}.png', {
					maxZoom: 16,
					attribution: 'Arsheet Company'
				}).addTo(map);

				init_pois();
				//var popup = L.popup();
				/*options = {};
				options.icon = test_marker;
				options.draggable = true;
				options.bounceOnAdd = true;
				options.bounceOnAddOptions = {duration: 500, height: 50};

				L.marker([36.36655, 59.49526], options).addTo(map);
				*/
				
				function onMapClick(e) {
					/*popup
						.setLatLng(e.latlng)
						.setContent("You clicked the map at " + e.latlng.toString())
						.openOn(map);
						*/
					
					if(state == "ROUTING"){
						if(routing_points.length < 2){
							var node_id = get_nearest_node(e.latlng.lat, e.latlng.lng);
							routing_markers.push(L.marker([json[node_id].lat, json[node_id].lon]).addTo(map));
							routing_points.push(node_id);
							
							if(routing_points.length == 2){
								var p1 = {id: routing_points[0], lat: json[routing_points[0]].lat, lon: json[routing_points[0]].lon};
								var p2 = {id: routing_points[1], lat: json[routing_points[1]].lat, lon: json[routing_points[1]].lon};
							
								var res = do_search(p1, p2);
								route = L.polyline(res, {color: 'blue'}).addTo(map);
								change_state("NONE");
							}
						}
					}
					
					
					
					if(state == "ADD_POI"){
						marker = L.marker(e.latlng, create_poi_marker('Accommodation')).addTo(map);
						//lst_poi[marker.id] = marker;
						
						db.transaction(function(tx){
							tx.executeSql("INSERT INTO POI ([lat], [lon], [type], [title], [text]) VALUES (?, ?, ?, ?, ?)", [e.latlng.lat.toString(), e.latlng.lng.toString(), 'Accommodation', '', ''], function(tx, result){
								var marker_id = result.insertId;
								lst_poi[marker_id] = marker;
						
								/*var elems = ['Accommodation', 'ATM', 'Bank', 'Car Aid', 'Education', 'Emergency', 'Entertainment', 'Exchange', 'Food Shop', 'Fuel', 'Geocache', 'Haram Entrance', 'Health', 'Hospital', 'Money', 'Parking', 'Resturant', 'Sightseeing', 'Transport'];
							
								var select = "<select style='width: 180px;' onchange=\"change_poi_type(" + marker_id + ", this)\">";
								for (var i = 0; i < elems.length; i++)
									select += "<option value='" + elems[i] + "' data-description='' data-image='images/poi/" + elems[i] + ".png'>" + elems[i] + "</option>";
								select += "</select>";
								
								var popup = "<table cellspacing=0 cellpadding=0><tr><td>Type:</td><td>" + select + "</td></tr><tr><td>Title:</td><td><input type=text /></td></tr><tr><td>Text:</td><td><textarea></textarea></td></tr><tr><td colspan=2 align=right><input type=button value=\"Delete\" /></td></table>";
								*/
								var popup = gen_poi_popup(marker_id);
								marker.bindPopup(popup);
								setTimeout(function(){marker.openPopup();}, 1000);
							});
						});
						
						change_state("NONE");
					}
				}

				map.on('click', onMapClick);

				map.on('popupopen', function(e) {
					$(".leaflet-popup-content select option").filter(function(){ 
						return $(this).val() == e.popup._source.options.icon.options.iconType;
					}).prop("selected", true); 
					$(".leaflet-popup-content select").msDropDown({height: 100});
					
					$(".leaflet-popup-content input[type=text]").val(e.popup._source.options.icon.options.title);
					$(".leaflet-popup-content textarea").val(e.popup._source.options.icon.options.text);
					
				});
				
			});
		
			</script>
			<!--a href="javascript:mosync.app.exit();">Exit</a-->
		</div>
	</body>
</html>
