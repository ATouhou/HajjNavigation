<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=320, user-scalable=no">
		<meta http-equiv="Content-type" content="text/html; charset=utf-8">
		<title>Map Test App</title>
		<style>
			body{
				margin: 0px;
			}
		</style>
		<link rel="stylesheet" href="plugin/leaflet/leaflet.css" />
		<link rel="stylesheet" href="plugin/toolbar/toolbar.css" />
		<link rel="stylesheet" href="css/dd.css" />
		<!--[if lte IE 8]><link rel="stylesheet" href="plugin/leaflet/leaflet.ie.css" /><![endif]-->
		<script src="js/jq.js"></script>
        <script type="text/javascript" src="js/jquery.dd.js"></script>
        <script type="text/javascript" src="phonegap.js"></script>
	</head>
	<body>
		<div id="screen">
			<div id="map" style="width: 600px; height: 400px"></div>
		
			<script src="plugin/leaflet/leaflet-src.js"></script>
			<script src="plugin/leaflet/bouncemarker.js"></script>
			<script type="text/javascript" src="js/markers.js"></script>
		
			<script src="plugin/routing/L.Routing.js"></script>
			<script src="plugin/routing/L.Routing.Draw.js"></script>
			<script src="plugin/routing/L.Routing.Edit.js"></script>
			<script src="plugin/routing/L.Routing.Storage.js"></script>
		
			<script src="plugin/routing/utils/LineUtil.Snapping.js"></script>
			<script src="plugin/routing/utils/Marker.Snapping.js"></script>
			<script src="plugin/routing/utils/Polyline.Snapping.js"></script>
		
			<script src="plugin/toolbar/toolbar.js"></script>
			<script>
			$(window).resize(function(){
				$("#map").width("100%");		
				$("#map").height($(window).height());
			});
			
			
			var my_location = null;
			
			var state = "NONE";
	
			lst_poi = {};
	
			function get_my_location(){
				navigator.geolocation.getCurrentPosition(function(position){
					if(my_location == null){
						L.marker([position.latitude, position.longitude]).addTo(map)
							.bindPopup("You are Here").openPopup();
					}
					my_location.setLatLng([position.latitude, position.longitude]).update();
				}, function(error){
					alert("Error retriving location");
				},
				{
					enableHighAccuracy : true,
					maximumAge: 4000,
					timeout: 5000
				});
			}
			
			function change_poi_type(id, select){
				var new_value = select.value;
				//lst_poi[id].options.icon.options.iconUrl = "images/poi/" + new_value + ".png";
				lst_poi[id].setIcon(create_poi_marker(new_value).icon);
			}
			
			$(document).ready(function(){
				$("#map").width("100%");		
				$("#map").height($(window).height());
				var map = L.map('map').setView([36.36753, 59.49519], 12);
				
				var container = L.DomUtil.create('div', 'myToolBar leaflet-bar');
				var link = L.DomUtil.create('a', '', container);
				link.innerHTML = "HELLO";

				
				var toolbar = new L.Control.Toolbar();
				map.addControl(toolbar);

				//L.tileLayer('http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/997/256/{z}/{x}/{y}.png', {
				L.tileLayer('map_data/{z}/{x}/{y}.png', {
					maxZoom: 15,
					attribution: 'Arsheet Company'
				}).addTo(map);

				//var popup = L.popup();
				/*options = {};
				options.icon = test_marker;
				options.draggable = true;
				options.bounceOnAdd = true;
				options.bounceOnAddOptions = {duration: 500, height: 50};

				L.marker([36.36655, 59.49526], options).addTo(map);
				*/
				/*L.marker([36.36655, 59.49526], create_poi_marker('bank')).addTo(map)
					.bindPopup("Hello");*/
				
				function onMapClick(e) {
					/*popup
						.setLatLng(e.latlng)
						.setContent("You clicked the map at " + e.latlng.toString())
						.openOn(map);
						*/
					if(state == "ADD_POI"){
						/*L.marker(e.latlng).addTo(map)
							.bindPopup("You clicked Here").openPopup();*/
						
						marker = L.marker(e.latlng, create_poi_marker('Accommodation')).addTo(map);
						lst_poi[marker.id] = marker;

						var elems = ['Accommodation', 'ATM', 'Bank', 'Car Aid', 'Education', 'Emergency', 'Entertainment', 'Exchange', 'Food Shop', 'Fuel', 'Geocache', 'Haram Entrance', 'Health', 'Hospital', 'Money', 'Parking', 'Resturant', 'Sightseeing', 'Transport'];
					
						var select = "<select style='width: 180px;' onchange=\"change_poi_type(" + marker.id + ", this)\">";
						for (var i = 0; i < elems.length; i++)
							select += "<option value='" + elems[i] + "' data-description='' data-image='images/poi/" + elems[i] + ".png'>" + elems[i] + "</option>";
						select += "</select>";
						
						var popup = "<table cellspacing=0 cellpadding=0><tr><td>Type:</td><td>" + select + "</td></tr><tr><td>Title:</td><td><input type=text /></td></tr><tr><td>Text:</td><td><textarea></textarea></td></tr><tr><td colspan=2 align=right><input type=button value=\"Delete\" /></td></table>";
						
						marker.bindPopup(popup);
						
						//console.log(marker.id);
						setTimeout(function(){marker.openPopup();}, 1000);
						
						//map.fire('popupopen', {popup: this});

						//$(".leaflet-popup-content select").msDropDown();
						
							//console.log($("body select"));
							//$(".leaflet-popup-content select").msDropDown();
						state = "NONE";
					}
				}

				map.on('click', onMapClick);

				map.on('popupopen', function(e) {
					$(".leaflet-popup-content select option").filter(function(){ 
						return $(this).val() == e.popup._source.options.icon.options.iconType;
					}).prop("selected", true); 
					$(".leaflet-popup-content select").msDropDown({height: 100});
				});
				
				myRouter = function(l1, l2, cb){
					layer = {_lanlngs: [l1, l2]};
					return cb(null);
				}
				
				
				/*myRouter = function(l1, l2, cb) {
				  var req = $.getJSON(rUrl + [l1.lng, l1.lat, l2.lng, l2.lat].join(',') + '&callback=?');
				  req.always(function(data, status) {
					if (status === 'success') {
					  try {
						L.GeoJSON.geometryToLayer(JSON.parse(data)).eachLayer(function (layer) {
						  // 14026
						  var d1 = l1.distanceTo(layer._latlngs[0]);
						  var d2 = l2.distanceTo(layer._latlngs[layer._latlngs.length-1]);
						  
						  if (d1 < 10 && d2 < 10) {
							return cb(null, layer);
						  } else {
							return cb(new Error('This has been discarded'));
						  }
						});
					  } catch(e) {
						return cb(new Error('Invalid JSON'));
					  }
					} else {
					  return cb(new Error('Routing failed'));
					}
				  });
				}*/

				snapping = new L.geoJson(null, {
				  style: {
					opacity:0
					,clickable:false
				  }
				}).addTo(map);

				
				
				var routing = new L.Routing({
				  position: 'bottomleft'
				  ,routing: {
					router: myRouter
				  }
				  ,snapping: {
					layers: [snapping]
					,sensitivity: 15
					,vertexonly: false
				  }
				});
				map.addControl(routing);
				//routing.draw(true);
			});
		
			</script>
			<!--a href="javascript:mosync.app.exit();">Exit</a-->
		</div>
	</body>
</html>
